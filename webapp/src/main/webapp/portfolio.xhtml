<ui:composition xmlns="http://www.w3.org/1999/xhtml"
                xmlns:h="jakarta.faces.html"
                xmlns:ui="jakarta.faces.facelets"
                xmlns:f="jakarta.faces.core"
                template="/templates/layout.xhtml">

    <ui:define name="title">Portefeuilles</ui:define>

    <ui:define name="content">
        <div class="page-content portfolio-page">

            <!-- En-tete compact -->
            <div class="portfolio-header">
                <h:form id="createPortfolioForm" styleClass="portfolio-create-form">
                    <h2>Mes portefeuilles</h2>

                    <div class="form-field">
                        <h:outputLabel for="newName" value="Nom du nouveau portefeuille" styleClass="field-label"/>
                        <h:inputText id="newName"
                                     value="#{portfolioBean.newPortfolioName}"
                                     styleClass="input-field"
                                     maxlength="60"/>
                    </div>

                    <h:commandButton value="Créer un portefeuille"
                                     styleClass="btn-primary"
                                     action="#{portfolioBean.createPortfolio}">
                        <f:ajax execute="@form"
                                render="selectPortfolioForm overviewPanel assetsPanel"/>
                    </h:commandButton>
                </h:form>

                <h:form id="selectPortfolioForm" styleClass="portfolio-select-form">
                    <h:outputLabel for="portfolioSelect"
                                   value="Portefeuille courant"
                                   styleClass="field-label"/>

                    <h:selectOneMenu id="portfolioSelect"
                                     value="#{portfolioBean.selectedPortfolioId}"
                                     styleClass="select-field">
                        <f:ajax listener="#{portfolioBean.loadAssets}"
                                render="overviewPanel assetsPanel"/>
                        <f:selectItem itemValue="" itemLabel="-- Aucun --" />
                        <!-- Affiche le nom du portefeuille plutot que 'Portefeuille #id' -->
                        <f:selectItems value="#{portfolioBean.portfolioIds}"
                                       var="pid"
                                       itemValue="#{pid}"
                                       itemLabel="#{portfolioBean.portfolioNames[portfolioBean.portfolioIds.indexOf(pid)]}" />
                    </h:selectOneMenu>
                </h:form>
            </div>

            <!-- Layout principal 2 colonnes -->
            <div class="portfolio-layout">

                <!-- Colonne gauche : aperçu + tableau -->
                <div class="portfolio-left">

                    <!-- Aperçu du portefeuille -->
                    <h:panelGroup id="overviewPanel" layout="block"
                                  styleClass="card portfolio-overview">
                        <div class="card-header">
                            <div class="card-title">
                                <span class="status-dot"></span>
                                <span>Aperçu du portefeuille</span>
                                <h:outputText value=" : #{portfolioBean.currentPortfolioName}"
                                              rendered="#{not empty portfolioBean.currentPortfolioName}"/>
                            </div>
                        </div>

                        <div class="portfolio-overview-body">
                            <div class="overview-metric">
                                <span class="overview-amount">$24,567.89</span>
                                <span class="overview-delta">+123.45 (0.51%) Aujourd'hui</span>
                            </div>
                            <div class="overview-chart-placeholder">
                                Graphique de performance (à intégrer)
                            </div>
                        </div>
                    </h:panelGroup>

                    <!-- Tableau des actifs -->
                    <h:panelGroup id="assetsPanel" layout="block"
                                  styleClass="card portfolio-assets-table">
                        <div class="card-header">
                            <div class="card-title">
                                <span class="status-dot green"></span>
                                <span>Actifs du portefeuille</span>
                            </div>
                        </div>

                        <h:panelGroup rendered="#{empty portfolioBean.assets}">
                            <p class="empty-state">Aucun actif dans ce portefeuille.</p>
                        </h:panelGroup>

                        <h:panelGroup rendered="#{not empty portfolioBean.assets}">
                            <ul class="assets-list">
                                <ui:repeat value="#{portfolioBean.assets}" var="a">
                                    <li class="assets-row">#{a}</li>
                                </ui:repeat>
                            </ul>
                        </h:panelGroup>
                    </h:panelGroup>
                </div>

                <!-- Colonne droite : ajout via API + custom asset -->
                <div class="portfolio-right">

                    <!-- Ajouter un actif (API) -->
                    <h:form id="apiForm" styleClass="card portfolio-add-api">
                        <div class="card-header">
                            <div class="card-title">
                                <span class="status-icon plus">+</span>
                                <span>Ajouter un actif</span>
                            </div>
                        </div>

                        <div class="card-body form-grid">
                            <!-- TYPE -->
                            <div class="form-field">
                                <label for="typeSelect" class="field-label">Type</label>
                                <h:selectOneMenu id="typeSelect"
                                                 value="#{portfolioBean.selectedType}"
                                                 styleClass="select-field">
                                    <f:ajax listener="#{portfolioBean.loadAssetsFromApi}"
                                            render="assetSelect priceField"/>
                                    <f:selectItem itemValue="" itemLabel="-- Choisir --"/>
                                    <f:selectItem itemValue="crypto" itemLabel="Crypto"/>
                                    <f:selectItem itemValue="stock" itemLabel="Action"/>
                                    <f:selectItem itemValue="etf" itemLabel="ETF"/>
                                </h:selectOneMenu>
                            </div>

                            <!-- ACTIF -->
                            <div class="form-field">
                                <label for="assetSelect" class="field-label">Actif</label>
                                <h:selectOneMenu id="assetSelect"
                                                 value="#{portfolioBean.selectedExternalAsset}"
                                                 styleClass="select-field">
                                    <f:ajax listener="#{portfolioBean.loadPriceForSelectedAsset}"
                                            render="priceField"/>
                                    <f:selectItems value="#{portfolioBean.availableAssets}"
                                                   var="a"
                                                   itemValue="#{a.symbol}"
                                                   itemLabel="#{a.name} (#{a.symbol})"/>
                                </h:selectOneMenu>
                            </div>

                            <!-- PRIX -->
                            <div class="form-field">
                                <label for="priceField" class="field-label">Prix (USD)</label>
                                <h:outputText id="priceField"
                                              styleClass="readonly-field"
                                              value="#{portfolioBean.marketUnitPrice}">
                                    <f:convertNumber maxFractionDigits="4"/>
                                </h:outputText>
                            </div>

                            <!-- QUANTITÉ -->
                            <div class="form-field">
                                <label class="field-label">Quantité</label>
                                <h:inputText value="#{portfolioBean.assetQuantity}"
                                             styleClass="input-field"/>
                            </div>
                        </div>

                        <div class="card-footer">
                            <h:commandButton value="Ajouter au portefeuille"
                                             styleClass="btn-primary full-width"
                                             action="#{portfolioBean.addAssetFromApi}">
                                <f:ajax execute="@form"
                                        render="assetsPanel overviewPanel"/>
                            </h:commandButton>
                        </div>
                    </h:form>

                    <!-- Créer un actif personnalisé -->
                    <h:form id="customAssetForm"
                            rendered="#{portfolioBean.showCustomAssetForm}"
                            styleClass="card portfolio-custom-asset">
                        <div class="card-header">
                            <div class="card-title">
                                <span class="status-icon pen">&#9998;</span>
                                <span>Créer un actif personnalisé</span>
                            </div>
                        </div>

                        <div class="card-body form-grid">
                            <div class="form-field">
                                <label class="field-label">Nom</label>
                                <h:inputText value="#{portfolioBean.assetName}"
                                             styleClass="input-field"/>
                            </div>

                            <div class="form-field">
                                <label class="field-label">Symbole</label>
                                <h:inputText value="#{portfolioBean.assetSymbol}"
                                             styleClass="input-field"/>
                            </div>

                            <div class="form-field">
                                <label class="field-label">Type</label>
                                <h:selectOneMenu value="#{portfolioBean.assetType}"
                                                 styleClass="select-field">
                                    <f:selectItem itemValue="crypto" itemLabel="Crypto"/>
                                    <f:selectItem itemValue="stock" itemLabel="Action"/>
                                    <f:selectItem itemValue="etf" itemLabel="ETF"/>
                                    <f:selectItem itemValue="other" itemLabel="Autre"/>
                                </h:selectOneMenu>
                            </div>

                            <div class="form-field">
                                <label class="field-label">Quantité</label>
                                <h:inputText value="#{portfolioBean.assetQuantity}"
                                             styleClass="input-field"/>
                            </div>

                            <div class="form-field">
                                <label class="field-label">Valeur unitaire</label>
                                <h:inputText value="#{portfolioBean.assetUnitValue}"
                                             styleClass="input-field"/>
                            </div>
                        </div>

                        <div class="card-footer">
                            <h:commandButton value="Ajouter l'actif personnalisé"
                                             styleClass="btn-secondary full-width"
                                             action="#{portfolioBean.addCustomAsset}">
                                <f:ajax execute="@form"
                                        render="assetsPanel overviewPanel customAssetForm customButtonForm"/>
                            </h:commandButton>
                        </div>
                    </h:form>

                    <!-- Bouton pour afficher/masquer le formulaire custom -->
                    <h:form id="customButtonForm" styleClass="portfolio-toggle-custom">
                        <h:commandButton value="#{portfolioBean.showCustomAssetForm ? 'Fermer le formulaire personnalisé' : 'Créer un actif personnalisé'}"
                                         styleClass="btn-ghost full-width"
                                         action="#{portfolioBean.toggleCustomAssetForm}">
                            <f:ajax render="customAssetForm customButtonForm"/>
                        </h:commandButton>
                    </h:form>

                </div>
            </div>
        </div>
    </ui:define>
</ui:composition>
