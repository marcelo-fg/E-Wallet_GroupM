<ui:composition xmlns="http://www.w3.org/1999/xhtml" xmlns:h="jakarta.faces.html" xmlns:ui="jakarta.faces.facelets"
    xmlns:f="jakarta.faces.core" template="/templates/layout.xhtml">

    <ui:define name="title">Portfolios</ui:define>

    <ui:define name="content">
        <div class="portfolio-page">

            <!-- ============ TOP BAR: SELECTED PORTFOLIO ============ -->
            <div class="bento-box glow-hover selected-portfolio-bar">
                <h:form id="portfolioSelectForm" styleClass="selected-portfolio-form">
                    <div class="portfolio-dropdown-section">
                        <h:panelGroup id="portfolioSelectPanel">
                            <!-- Show dropdown only if portfolios exist -->
                            <h:panelGroup rendered="#{not empty portfolioBean.portfolioInfos}">
                                <h:selectOneMenu id="portfolioSelect" value="#{portfolioBean.selectedPortfolioId}"
                                    styleClass="select-field portfolio-dropdown">
                                    <f:ajax listener="#{portfolioBean.loadAssets}"
                                        render="portfolioSelectPanel assetsPanel portfolioValueDisplay sellPanel" />
                                    <f:selectItems value="#{portfolioBean.portfolioInfos}" var="pInfo"
                                        itemValue="#{pInfo.id}" itemLabel="#{pInfo.name}" />
                                </h:selectOneMenu>

                                <h:commandLink action="#{portfolioBean.goToAnalytics}" styleClass="analytics-link"
                                    rendered="#{not empty portfolioBean.selectedPortfolioId}">
                                    View Analytics &#8594;
                                </h:commandLink>

                                <!-- Delete Portfolio Button -->
                                <h:commandButton value="Delete Portfolio" styleClass="btn-danger-sm"
                                    rendered="#{not empty portfolioBean.selectedPortfolioId}"
                                    onclick="return confirm('Are you sure you want to delete this portfolio? All assets will be lost.');"
                                    action="#{portfolioBean.deleteSelectedPortfolio}">
                                    <f:ajax execute="@this"
                                        render=":portfolioSelectForm:portfolioSelectPanel :portfolioSelectForm:portfolioValueDisplay assetsPanel sellPanel :globalMessages" />
                                </h:commandButton>
                            </h:panelGroup>

                            <!-- Show message when no portfolios exist -->
                            <h:panelGroup rendered="#{empty portfolioBean.portfolioInfos}"
                                styleClass="no-portfolio-message">
                                <span style="color: rgba(255,255,255,0.6); font-style: italic;">
                                    Create your first portfolio to get started
                                </span>
                            </h:panelGroup>
                        </h:panelGroup>
                    </div>

                    <h:panelGroup id="portfolioValueDisplay" styleClass="portfolio-value-section">
                        <h:panelGroup
                            rendered="#{not empty portfolioBean.selectedPortfolioId and not empty portfolioBean.assets}">
                            <span class="portfolio-value-label">TOTAL VALUE</span>
                            <span
                                class="portfolio-value-amount animate-count">#{portfolioBean.formattedTotalPortfolioValue}</span>
                        </h:panelGroup>
                        <h:panelGroup rendered="#{empty portfolioBean.selectedPortfolioId}">
                            <span class="portfolio-value-label">NO PORTFOLIO SELECTED</span>
                        </h:panelGroup>
                    </h:panelGroup>
                </h:form>
            </div>

            <!-- ============ MAIN CONTENT: 3 COLUMNS ============ -->
            <div class="portfolio-grid">

                <!-- COLUMN 1: Portfolio Assets -->
                <div class="portfolio-column">
                    <h:panelGroup id="assetsPanel" layout="block"
                        styleClass="bento-box glow-hover portfolio-assets-box">
                        <h3>Portfolio Assets</h3>
                        <p class="bento-description">Your current holdings</p>

                        <h:panelGroup rendered="#{empty portfolioBean.assets}">
                            <p class="empty-state">No assets in this portfolio.</p>
                        </h:panelGroup>

                        <h:panelGroup rendered="#{not empty portfolioBean.assets}">
                            <ul class="assets-list">
                                <ui:repeat value="#{portfolioBean.assets}" var="a">
                                    <li class="assets-row">#{a}</li>
                                </ui:repeat>
                            </ul>
                        </h:panelGroup>
                    </h:panelGroup>
                </div>

                <!-- COLUMN 2: Create Portfolio + Add from Market -->
                <div class="portfolio-column">
                    <h:form id="createPortfolioForm" styleClass="bento-box glow-hover">
                        <h3>New Portfolio</h3>
                        <div class="form-grid compact">
                            <div class="form-field">
                                <h:outputLabel for="newName" value="Name" styleClass="field-label" />
                                <h:inputText id="newName" value="#{portfolioBean.portfolioName}"
                                    styleClass="input-field" maxlength="60" />
                            </div>
                        </div>
                        <h:commandButton value="Create" styleClass="btn-primary full-width mt-10"
                            action="#{portfolioBean.createPortfolio}">
                            <f:ajax execute="@form"
                                render=":portfolioSelectForm:portfolioSelectPanel :portfolioSelectForm:portfolioValueDisplay assetsPanel sellPanel :globalMessages"
                                onevent="onPortfolioCreated" />
                        </h:commandButton>
                    </h:form>

                    <h:form id="apiForm" styleClass="bento-box glow-hover">
                        <h3>Add from Market</h3>
                        <div class="form-grid compact">
                            <div class="form-field">
                                <h:outputLabel for="typeSelect" value="Type" styleClass="field-label" />
                                <h:selectOneMenu id="typeSelect" value="#{portfolioBean.selectedType}"
                                    styleClass="select-field">
                                    <f:ajax listener="#{portfolioBean.loadAssetsFromApi}"
                                        render="assetSelect priceField" />
                                    <f:selectItem itemValue="" itemLabel="-- Select --" />
                                    <f:selectItem itemValue="crypto" itemLabel="Crypto" />
                                    <f:selectItem itemValue="stock" itemLabel="Stock" />
                                    <f:selectItem itemValue="etf" itemLabel="ETF" />
                                </h:selectOneMenu>
                            </div>

                            <div class="form-field">
                                <h:outputLabel for="assetSelect" value="Asset" styleClass="field-label" />
                                <h:selectOneMenu id="assetSelect" value="#{portfolioBean.selectedExternalAsset}"
                                    styleClass="select-field">
                                    <f:ajax listener="#{portfolioBean.loadPriceForSelectedAsset}" render="priceField" />
                                    <f:selectItems value="#{portfolioBean.availableAssets}" var="a"
                                        itemValue="#{a.symbol}" itemLabel="#{a.name} (#{a.symbol})" />
                                </h:selectOneMenu>
                            </div>

                            <div class="form-row-2col">
                                <div class="form-field">
                                    <h:outputLabel for="priceField" value="Price" styleClass="field-label" />
                                    <h:outputText id="priceField" styleClass="readonly-field"
                                        value="#{portfolioBean.marketUnitPrice}">
                                        <f:convertNumber maxFractionDigits="2" />
                                    </h:outputText>
                                </div>

                                <div class="form-field">
                                    <h:outputLabel value="Qty" styleClass="field-label" />
                                    <h:inputText value="#{portfolioBean.assetQuantity}" styleClass="input-field" />
                                </div>
                            </div>
                        </div>
                        <h:commandButton value="Add to Portfolio" styleClass="btn-primary full-width mt-10"
                            action="#{portfolioBean.addAssetFromApi}">
                            <f:ajax execute="@form"
                                render="assetsPanel :portfolioSelectForm:portfolioValueDisplay sellPanel :globalMessages"
                                onevent="onAssetAdded" />
                        </h:commandButton>
                    </h:form>
                </div>

                <!-- COLUMN 3: Custom Asset (Collapsible) + Sell Asset -->
                <div class="portfolio-column">
                    <!-- Custom Asset - Collapsible -->
                    <div class="bento-box glow-hover collapsible-section">
                        <div class="collapsible-header" onclick="toggleCollapsible(this)">
                            <h3>Custom Asset</h3>
                            <span class="collapsible-icon">▼</span>
                        </div>
                        <p class="bento-description">Add unlisted assets manually</p>

                        <h:form id="customAssetForm" styleClass="collapsible-content collapsed">
                            <div class="form-grid compact">
                                <div class="form-row-2col">
                                    <div class="form-field">
                                        <h:outputLabel value="Name" styleClass="field-label" />
                                        <h:inputText value="#{portfolioBean.assetName}" styleClass="input-field" />
                                    </div>
                                    <div class="form-field">
                                        <h:outputLabel value="Symbol" styleClass="field-label" />
                                        <h:inputText value="#{portfolioBean.assetSymbol}" styleClass="input-field" />
                                    </div>
                                </div>

                                <div class="form-field">
                                    <h:outputLabel value="Type" styleClass="field-label" />
                                    <h:selectOneMenu value="#{portfolioBean.assetType}" styleClass="select-field">
                                        <f:selectItem itemValue="crypto" itemLabel="Crypto" />
                                        <f:selectItem itemValue="stock" itemLabel="Stock" />
                                        <f:selectItem itemValue="etf" itemLabel="ETF" />
                                        <f:selectItem itemValue="other" itemLabel="Other" />
                                    </h:selectOneMenu>
                                </div>

                                <div class="form-row-2col">
                                    <div class="form-field">
                                        <h:outputLabel value="Quantity" styleClass="field-label" />
                                        <h:inputText value="#{portfolioBean.assetQuantity}" styleClass="input-field" />
                                    </div>
                                    <div class="form-field">
                                        <h:outputLabel value="Unit Price" styleClass="field-label" />
                                        <h:inputText value="#{portfolioBean.assetUnitValue}" styleClass="input-field" />
                                    </div>
                                </div>
                            </div>
                            <h:commandButton value="Add Custom Asset" styleClass="btn-secondary full-width mt-10"
                                action="#{portfolioBean.addCustomAsset}">
                                <f:ajax execute="@form" render="assetsPanel portfolioValueDisplay sellPanel" />
                            </h:commandButton>
                        </h:form>
                    </div>

                    <!-- Sell Asset -->
                    <h:panelGroup id="sellPanel" layout="block">
                        <h:form id="sellForm"
                            rendered="#{not empty portfolioBean.selectedPortfolioId and not empty portfolioBean.assets}"
                            styleClass="bento-box glow-hover">
                            <h3>Sell Asset</h3>
                            <div class="form-grid compact">
                                <div class="form-field">
                                    <h:outputLabel value="Asset" styleClass="field-label" />
                                    <h:selectOneMenu id="sellAssetSelect" value="#{portfolioBean.selectedHeldSymbol}"
                                        styleClass="select-field">
                                        <f:ajax listener="#{portfolioBean.onAssetSelectedForSale}"
                                            render="sellPriceField" />
                                        <f:selectItem itemValue="" itemLabel="-- Select --" />
                                        <f:selectItems value="#{portfolioBean.soldAssetOptions}" />
                                    </h:selectOneMenu>
                                </div>

                                <div class="form-row-2col">
                                    <div class="form-field">
                                        <h:outputLabel value="Price" styleClass="field-label" />
                                        <h:outputText id="sellPriceField" value="#{portfolioBean.sellMarketPrice}"
                                            styleClass="readonly-field">
                                            <f:convertNumber maxFractionDigits="2" />
                                        </h:outputText>
                                    </div>
                                    <div class="form-field">
                                        <h:outputLabel value="Qty" styleClass="field-label" />
                                        <h:inputText id="sellQuantityField" value="#{portfolioBean.sellQuantity}"
                                            styleClass="input-field" />
                                    </div>
                                </div>
                            </div>
                            <h:commandButton value="Sell" styleClass="btn-danger full-width mt-10"
                                action="#{portfolioBean.sellAssetAtMarketPrice}">
                                <f:ajax execute="@form" render="assetsPanel portfolioValueDisplay sellPanel" />
                            </h:commandButton>
                        </h:form>
                    </h:panelGroup>
                </div>

            </div>
        </div>

        <!-- JavaScript for collapsible functionality and notifications -->
        <script type="text/javascript">
            function toggleCollapsible(header) {
                var section = header.closest('.collapsible-section');
                var content = section.querySelector('.collapsible-content');
                var icon = header.querySelector('.collapsible-icon');

                if (content.classList.contains('collapsed')) {
                    content.classList.remove('collapsed');
                    icon.textContent = '▲';
                } else {
                    content.classList.add('collapsed');
                    icon.textContent = '▼';
                }
            }

            function showNotification(message, type) {
                // Create notification element
                var notification = document.createElement('div');
                notification.className = 'toast-notification ' + (type || 'success');
                notification.innerHTML = message;
                document.body.appendChild(notification);

                // Animate in
                setTimeout(function () { notification.classList.add('show'); }, 10);

                // Auto-remove after 3 seconds
                setTimeout(function () {
                    notification.classList.remove('show');
                    setTimeout(function () { notification.remove(); }, 300);
                }, 3000);
            }

            function onPortfolioCreated(data) {
                if (data.status === 'success') {
                    showNotification('Portfolio created successfully!', 'success');
                }
            }

            function onAssetAdded(data) {
                if (data.status === 'success') {
                    showNotification('Asset added to portfolio!', 'success');
                }
            }
        </script>

        <style>
            .toast-notification {
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 16px 24px;
                border-radius: 12px;
                color: white;
                font-weight: 500;
                z-index: 9999;
                opacity: 0;
                transform: translateX(50px);
                transition: all 0.3s ease;
                box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            }

            .toast-notification.show {
                opacity: 1;
                transform: translateX(0);
            }

            .toast-notification.success {
                background: linear-gradient(135deg, #10b981, #059669);
            }

            .toast-notification.error {
                background: linear-gradient(135deg, #ef4444, #dc2626);
            }

            .toast-notification.info {
                background: linear-gradient(135deg, #3b82f6, #2563eb);
            }
        </style>
    </ui:define>

</ui:composition>