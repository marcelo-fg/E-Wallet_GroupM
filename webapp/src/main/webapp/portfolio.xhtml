<ui:composition xmlns="http://www.w3.org/1999/xhtml"
                xmlns:h="jakarta.faces.html"
                xmlns:ui="jakarta.faces.facelets"
                xmlns:f="jakarta.faces.core"
                template="/templates/layout.xhtml">

    <ui:define name="title">Portefeuilles</ui:define>

    <ui:define name="content">
        <div class="page-content portfolio-page">

            <!-- BLOC HAUT : CHOIX / CREATION DU PORTFOLIO -->
            <!-- La barre haute est une vraie card, donc même hover que les bento-box -->
            <div class="portfolio-top-bar card">
                <h:form id="portfolioTopForm" styleClass="portfolio-top-form">

                    <!-- Nom nouveau portefeuille -->
                    <div class="form-field">
                        <h:outputLabel for="newName"
                                       value="Nom du nouveau portefeuille"
                                       styleClass="field-label"/>
                        <h:inputText id="newName"
                                     value="#{portfolioBean.portfolioName}"
                                     styleClass="input-field"
                                     maxlength="60"/>
                    </div>

                    <!-- Bouton création -->
                    <div class="form-actions">
                        <h:commandButton value="Créer un portefeuille"
                                         styleClass="btn-primary"
                                         action="#{portfolioBean.createPortfolio}">
                            <f:ajax execute="@form"
                                    render="portfolioSelectPanel portfolioSelectedPanel assetsPanel"/>
                        </h:commandButton>
                    </div>

                    <!-- Sélection portefeuille existant -->
                    <div id="portfolioSelectPanel" class="portfolio-select-inline">
                        <h:outputLabel for="portfolioSelect"
                                       value="Portefeuille courant"
                                       styleClass="field-label"/>

                        <h:selectOneMenu id="portfolioSelect"
                                         value="#{portfolioBean.selectedPortfolioId}"
                                         styleClass="select-field">
                            <f:ajax listener="#{portfolioBean.loadAssets}"
                                    render="portfolioSelectedPanel assetsPanel"/>

                            <f:selectItem itemValue="" itemLabel="-- Aucun --"/>
                            <f:selectItems value="#{portfolioBean.portfolioIds}"
                                           var="pid"
                                           itemValue="#{pid}"
                                           itemLabel="Portefeuille #{pid}"/>
                        </h:selectOneMenu>
                    </div>

                </h:form>
            </div>

            <!-- LAYOUT 2 COLONNES COMME LA MAQUETTE -->
            <div class="portfolio-layout">

                <!-- COLONNE GAUCHE : PORTFOLIO SELECTIONNE + ASSETS -->
                <div class="portfolio-left">

                    <!-- Portfolio sélectionné : card => même hover que bento-box -->
                    <h:panelGroup id="portfolioSelectedPanel" layout="block"
                                  styleClass="card portfolio-selected">
                        <div class="card-header">
                            <div class="card-title">
                                <span>Portfolio sélectionné</span>
                            </div>
                        </div>
                        <div class="card-body">
                            <h:outputText value="Portefeuille #{portfolioBean.selectedPortfolioId}"
                                          rendered="#{not empty portfolioBean.selectedPortfolioId}"/>
                            <h:outputText value="Aucun portefeuille sélectionné"
                                          rendered="#{empty portfolioBean.selectedPortfolioId}"/>
                        </div>
                    </h:panelGroup>

                    <!-- Assets du portfolio : card => même hover -->
                    <h:panelGroup id="assetsPanel" layout="block"
                                  styleClass="card portfolio-assets-table">
                        <div class="card-header">
                            <div class="card-title">
                                <span>Assets du portfolio</span>
                            </div>
                        </div>

                        <h:panelGroup rendered="#{empty portfolioBean.assets}">
                            <p class="empty-state">
                                Aucun actif dans ce portefeuille.
                            </p>
                        </h:panelGroup>

                        <h:panelGroup rendered="#{not empty portfolioBean.assets}">
                            <ul class="assets-list">
                                <ui:repeat value="#{portfolioBean.assets}" var="a">
                                    <li class="assets-row">#{a}</li>
                                </ui:repeat>
                            </ul>
                        </h:panelGroup>
                    </h:panelGroup>
                </div>

                <!-- COLONNE DROITE : AJOUT VIA API + CREATION PERSONNALISEE -->
                <div class="portfolio-right">

                    <!-- Ajouter un actif (API) : card => même hover que bento-box -->
                    <h:form id="apiForm" styleClass="card portfolio-add-api">
                        <div class="card-header">
                            <div class="card-title">
                                <span>Ajouter un actif</span>
                            </div>
                        </div>

                        <div class="card-body form-grid">
                            <!-- Choix type actif -->
                            <div class="form-field">
                                <label for="typeSelect" class="field-label">Choix type actif</label>
                                <h:selectOneMenu id="typeSelect"
                                                 value="#{portfolioBean.selectedType}"
                                                 styleClass="select-field">
                                    <f:ajax listener="#{portfolioBean.loadAssetsFromApi}"
                                            render="assetSelect priceField"/>
                                    <f:selectItem itemValue="" itemLabel="-- Choisir --"/>
                                    <f:selectItem itemValue="crypto" itemLabel="Crypto"/>
                                    <f:selectItem itemValue="stock" itemLabel="Action"/>
                                    <f:selectItem itemValue="etf" itemLabel="ETF"/>
                                </h:selectOneMenu>
                            </div>

                            <!-- Choix actif -->
                            <div class="form-field">
                                <label for="assetSelect" class="field-label">Choix actif</label>
                                <h:selectOneMenu id="assetSelect"
                                                 value="#{portfolioBean.selectedExternalAsset}"
                                                 styleClass="select-field">
                                    <f:ajax listener="#{portfolioBean.loadPriceForSelectedAsset}"
                                            render="priceField"/>
                                    <f:selectItems value="#{portfolioBean.availableAssets}"
                                                   var="a"
                                                   itemValue="#{a.symbol}"
                                                   itemLabel="#{a.name} (#{a.symbol})"/>
                                </h:selectOneMenu>
                            </div>

                            <!-- Prix actif -->
                            <div class="form-field">
                                <label for="priceField" class="field-label">Prix actif (USD)</label>
                                <h:outputText id="priceField"
                                              styleClass="readonly-field"
                                              value="#{portfolioBean.marketUnitPrice}">
                                    <f:convertNumber maxFractionDigits="4"/>
                                </h:outputText>
                            </div>

                            <!-- Quantité -->
                            <div class="form-field">
                                <label class="field-label">Quantité</label>
                                <h:inputText value="#{portfolioBean.assetQuantity}"
                                             styleClass="input-field"/>
                            </div>
                        </div>

                        <div class="card-footer">
                            <h:commandButton value="Ajouter au portfolio"
                                             styleClass="btn-primary full-width"
                                             action="#{portfolioBean.addAssetFromApi}">
                                <f:ajax execute="@form"
                                        render="assetsPanel portfolioSelectedPanel"/>
                            </h:commandButton>
                        </div>
                    </h:form>

                    <!-- Création personnalisée d'un actif : card => même hover -->
                    <h:form id="customAssetForm" styleClass="card portfolio-custom-asset">
                        <div class="card-header">
                            <div class="card-title">
                                <span>Création personnalisée d'un actif</span>
                            </div>
                        </div>

                        <div class="card-body form-grid">
                            <div class="form-field">
                                <label class="field-label">Nom</label>
                                <h:inputText value="#{portfolioBean.assetName}"
                                             styleClass="input-field"/>
                            </div>

                            <div class="form-field">
                                <label class="field-label">Symbole</label>
                                <h:inputText value="#{portfolioBean.assetSymbol}"
                                             styleClass="input-field"/>
                            </div>

                            <div class="form-field">
                                <label class="field-label">Type</label>
                                <h:selectOneMenu value="#{portfolioBean.assetType}"
                                                 styleClass="select-field">
                                    <f:selectItem itemValue="crypto" itemLabel="Crypto"/>
                                    <f:selectItem itemValue="stock" itemLabel="Action"/>
                                    <f:selectItem itemValue="etf" itemLabel="ETF"/>
                                    <f:selectItem itemValue="other" itemLabel="Autre"/>
                                </h:selectOneMenu>
                            </div>

                            <div class="form-field">
                                <label class="field-label">Quantité</label>
                                <h:inputText value="#{portfolioBean.assetQuantity}"
                                             styleClass="input-field"/>
                            </div>

                            <div class="form-field">
                                <label class="field-label">Valeur unitaire</label>
                                <h:inputText value="#{portfolioBean.assetUnitValue}"
                                             styleClass="input-field"/>
                            </div>
                        </div>

                        <div class="card-footer">
                            <h:commandButton value="Ajouter l'actif personnalisé"
                                             styleClass="btn-secondary full-width"
                                             action="#{portfolioBean.addCustomAsset}">
                                <f:ajax execute="@form"
                                        render="assetsPanel portfolioSelectedPanel"/>
                            </h:commandButton>
                        </div>
                    </h:form>

                </div>
            </div>
        </div>
    </ui:define>
</ui:composition>
