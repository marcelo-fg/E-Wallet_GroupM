<ui:composition xmlns="http://www.w3.org/1999/xhtml" xmlns:h="jakarta.faces.html" xmlns:ui="jakarta.faces.facelets"
    xmlns:f="jakarta.faces.core" template="/templates/layout.xhtml">

    <ui:define name="title">Portfolios</ui:define>

    <ui:define name="content">
        <!-- Reduced top padding to absolute minimum (matching nav height) -->
        <div class="page-content portfolio-page" style="padding-top: 70px;">

            <!-- BLOC HAUT : CHOIX / CREATION DU PORTFOLIO (FULL WIDTH) -->
            <div class="bento-box glow-hover" style="margin-bottom: 0;">
                <h:form id="portfolioTopForm" styleClass="portfolio-top-form">

                    <!-- Nom nouveau portefeuille -->
                    <div class="form-field">
                        <h:outputLabel for="newName" value="New Portfolio Name" styleClass="field-label" />
                        <h:inputText id="newName" value="#{portfolioBean.portfolioName}" styleClass="input-field"
                            maxlength="60" />
                    </div>

                    <!-- Bouton création -->
                    <div class="form-actions">
                        <h:commandButton value="Create Portfolio" styleClass="btn-primary"
                            action="#{portfolioBean.createPortfolio}">
                            <f:ajax execute="@form" render="portfolioSelectPanel portfolioSelectedPanel assetsPanel" />
                        </h:commandButton>
                    </div>

                    <!-- Sélection portefeuille existant -->
                    <div class="portfolio-select-inline">
                        <h:panelGroup id="portfolioSelectPanel">
                            <h:outputLabel for="portfolioSelect" value="Current Portfolio" styleClass="field-label" />

                            <h:selectOneMenu id="portfolioSelect" value="#{portfolioBean.selectedPortfolioId}"
                                styleClass="select-field">
                                <f:ajax listener="#{portfolioBean.loadAssets}"
                                    render="portfolioSelectedPanel assetsPanel" />

                                <f:selectItem itemValue="" itemLabel="-- None --" />
                                <f:selectItems value="#{portfolioBean.portfolioIds}" var="pid" itemValue="#{pid}"
                                    itemLabel="Portfolio #{pid}" />
                            </h:selectOneMenu>
                        </h:panelGroup>
                    </div>
                </h:form>
            </div>

            <!-- LAYOUT 2 COLONNES -->
            <div class="portfolio-layout">

                <!-- COLONNE GAUCHE -->
                <div class="portfolio-left">

                    <!-- Portfolio sélectionné (Clickable for Analytics) -->
                    <h:form style="display:contents;">
                        <h:commandLink action="#{portfolioBean.goToAnalytics}"
                            styleClass="bento-box glow-hover portfolio-selected"
                            style="display:block; text-decoration:none; color:inherit; text-align:left; cursor:pointer;">
                            <h2 style="display:flex; justify-content:space-between; align-items:center;">
                                Selected Portfolio
                                <span style="font-size:14px; opacity:0.6; font-weight:normal;">View Analytics
                                    &#8594;</span>
                            </h2>
                            <h:outputText value="#{portfolioBean.portfolioNames[portfolioBean.selectedPortfolioId]}"
                                rendered="#{not empty portfolioBean.selectedPortfolioId}"
                                style="font-size:18px; display:block; margin-bottom:10px;" />
                            <h:outputText value="No portfolio selected"
                                rendered="#{empty portfolioBean.selectedPortfolioId}" />

                            <!-- Portfolio Total Value -->
                            <h:panelGroup rendered="#{not empty portfolioBean.assets}">
                                <div
                                    style="margin-top: 20px; padding: 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 12px;">
                                    <h3
                                        style="margin: 0 0 10px 0; font-size: 14px; color: rgba(255,255,255,0.9); text-transform: uppercase; letter-spacing: 1px;">
                                        Portfolio Total Value
                                    </h3>
                                    <div style="font-size: 32px; font-weight: bold; color: white;">
                                        #{portfolioBean.formattedTotalPortfolioValue}
                                    </div>
                                </div>
                            </h:panelGroup>
                        </h:commandLink>
                    </h:form>

                    <!-- Assets du portfolio -->
                    <h:panelGroup id="assetsPanel" layout="block" styleClass="bento-box glow-hover">
                        <h3>Portfolio Assets</h3>
                        <p class="bento-description">
                            List of all assets in your portfolio.
                        </p>
                        <h:panelGroup rendered="#{empty portfolioBean.assets}">
                            <p class="empty-state">
                                No assets in this portfolio.
                            </p>
                        </h:panelGroup>

                        <h:panelGroup rendered="#{not empty portfolioBean.assets}">
                            <ul class="assets-list">
                                <ui:repeat value="#{portfolioBean.assets}" var="a">
                                    <li class="assets-row">#{a}</li>
                                </ui:repeat>
                            </ul>
                        </h:panelGroup>
                    </h:panelGroup>
                </div>

                <!-- COLONNE DROITE -->
                <div class="portfolio-right">

                    <!-- Ajouter un actif (API) -->
                    <h:form id="apiForm" styleClass="card portfolio-add-api">
                        <div class="card-header">
                            <div class="card-title">
                                <span>Add Asset (from Market)</span>
                            </div>
                        </div>

                        <div class="card-body form-grid">
                            <div class="form-field">
                                <h:outputLabel for="typeSelect" value="Asset Type" styleClass="field-label" />
                                <h:selectOneMenu id="typeSelect" value="#{portfolioBean.selectedType}"
                                    styleClass="select-field">
                                    <f:ajax listener="#{portfolioBean.loadAssetsFromApi}"
                                        render="assetSelect priceField" />
                                    <f:selectItem itemValue="" itemLabel="-- Select --" />
                                    <f:selectItem itemValue="crypto" itemLabel="Crypto" />
                                    <f:selectItem itemValue="stock" itemLabel="Stock" />
                                    <f:selectItem itemValue="etf" itemLabel="ETF" />
                                </h:selectOneMenu>
                            </div>

                            <div class="form-field">
                                <h:outputLabel for="assetSelect" value="Choose Asset" styleClass="field-label" />
                                <h:selectOneMenu id="assetSelect" value="#{portfolioBean.selectedExternalAsset}"
                                    styleClass="select-field">
                                    <f:ajax listener="#{portfolioBean.loadPriceForSelectedAsset}" render="priceField" />
                                    <f:selectItems value="#{portfolioBean.availableAssets}" var="a"
                                        itemValue="#{a.symbol}" itemLabel="#{a.name} (#{a.symbol})" />
                                </h:selectOneMenu>
                            </div>

                            <div class="form-field">
                                <h:outputLabel for="priceField" value="Price (USD)" styleClass="field-label" />
                                <h:outputText id="priceField" styleClass="readonly-field"
                                    value="#{portfolioBean.marketUnitPrice}">
                                    <f:convertNumber maxFractionDigits="4" />
                                </h:outputText>
                            </div>

                            <div class="form-field">
                                <h:outputLabel value="Quantity" styleClass="field-label" />
                                <h:inputText value="#{portfolioBean.assetQuantity}" styleClass="input-field" />
                            </div>
                        </div>

                        <div class="card-footer">
                            <h:commandButton value="Add to Portfolio" styleClass="btn-primary full-width"
                                action="#{portfolioBean.addAssetFromApi}">
                                <f:ajax execute="@form" render="assetsPanel portfolioSelectedPanel" />
                            </h:commandButton>
                        </div>
                    </h:form>

                    <!-- Création personnalisée -->
                    <h:form id="customAssetForm" styleClass="card portfolio-custom-asset">
                        <div class="card-header">
                            <div class="card-title">
                                <span>Add Custom Asset</span>
                            </div>
                        </div>

                        <div class="card-body form-grid">
                            <div class="form-field">
                                <h:outputLabel value="Name" styleClass="field-label" />
                                <h:inputText value="#{portfolioBean.assetName}" styleClass="input-field" />
                            </div>

                            <div class="form-field">
                                <h:outputLabel value="Symbol" styleClass="field-label" />
                                <h:inputText value="#{portfolioBean.assetSymbol}" styleClass="input-field" />
                            </div>

                            <div class="form-field">
                                <h:outputLabel value="Type" styleClass="field-label" />
                                <h:selectOneMenu value="#{portfolioBean.assetType}" styleClass="select-field">
                                    <f:selectItem itemValue="crypto" itemLabel="Crypto" />
                                    <f:selectItem itemValue="stock" itemLabel="Stock" />
                                    <f:selectItem itemValue="etf" itemLabel="ETF" />
                                    <f:selectItem itemValue="other" itemLabel="Other" />
                                </h:selectOneMenu>
                            </div>

                            <div class="form-field">
                                <h:outputLabel value="Quantity" styleClass="field-label" />
                                <h:inputText value="#{portfolioBean.assetQuantity}" styleClass="input-field" />
                            </div>

                            <div class="form-field">
                                <h:outputLabel value="Unit Value" styleClass="field-label" />
                                <h:inputText value="#{portfolioBean.assetUnitValue}" styleClass="input-field" />
                            </div>
                        </div>

                        <div class="card-footer">
                            <h:commandButton value="Add Custom Asset" styleClass="btn-secondary full-width"
                                action="#{portfolioBean.addCustomAsset}">
                                <f:ajax execute="@form" render="assetsPanel portfolioSelectedPanel" />
                            </h:commandButton>
                        </div>
                    </h:form>

                    <!-- ============ SELL ASSET FORM ============ -->
                    <h:panelGroup id="sellPanel">
                        <h:form id="sellForm" rendered="#{not empty portfolioBean.assets}" styleClass="card">
                            <div class="card-header">
                                <div class="card-title">
                                    <span>Sell Asset</span>
                                </div>
                            </div>

                            <div class="card-body form-grid">
                                <div class="form-field">
                                    <h:outputLabel value="Select Asset to Sell" styleClass="field-label" />
                                    <h:selectOneMenu id="sellAssetSelect" value="#{portfolioBean.selectedHeldSymbol}"
                                        styleClass="select-field">
                                        <f:ajax listener="#{portfolioBean.onAssetSelectedForSale}"
                                            render="sellPriceField" />
                                        <f:selectItem itemValue="" itemLabel="-- Select Asset --" />
                                        <f:selectItems value="#{portfolioBean.soldAssetOptions}" />
                                    </h:selectOneMenu>
                                </div>

                                <div class="form-field">
                                    <h:outputLabel value="Market Price (USD)" styleClass="field-label" />
                                    <h:outputText id="sellPriceField" value="#{portfolioBean.sellMarketPrice}"
                                        styleClass="readonly-field">
                                        <f:convertNumber maxFractionDigits="4" />
                                    </h:outputText>
                                </div>

                                <div class="form-field">
                                    <h:outputLabel value="Quantity to Sell" styleClass="field-label" />
                                    <h:inputText id="sellQuantityField" value="#{portfolioBean.sellQuantity}"
                                        styleClass="input-field" />
                                </div>
                            </div>

                            <div class="card-footer">
                                <h:commandButton value="Sell Asset" styleClass="btn-danger full-width"
                                    action="#{portfolioBean.sellAssetAtMarketPrice}">
                                    <f:ajax execute="@form" render="assetsPanel portfolioSelectedPanel sellPanel" />
                                </h:commandButton>
                            </div>
                        </h:form>
                    </h:panelGroup>

                </div>
            </div>
        </div>
    </ui:define>
</ui:composition>