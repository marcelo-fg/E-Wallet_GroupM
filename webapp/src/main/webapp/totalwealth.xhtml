<ui:composition xmlns="http://www.w3.org/1999/xhtml" xmlns:h="http://xmlns.jcp.org/jsf/html"
    xmlns:f="http://xmlns.jcp.org/jsf/core" xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
    template="/templates/layout.xhtml">

    <ui:define name="title">Total Wealth - WealthMate</ui:define>

    <ui:define name="content">
        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

        <style>
            .wealth-page {
                display: flex;
                flex-direction: column;
                gap: 15px;
            }

            /* Main Grid Layout - 2 columns like dashboard */
            .wealth-grid {
                display: grid;
                grid-template-columns: 65% 35%;
                gap: 15px;
                min-height: calc(100vh - 170px);
            }

            .wealth-main {
                display: flex;
                flex-direction: column;
                gap: 15px;
            }

            .wealth-sidebar {
                display: flex;
                flex-direction: column;
                gap: 15px;
            }

            /* Header section inside main bento box */
            .wealth-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 20px;
            }

            .wealth-title h2 {
                margin: 0;
                font-size: 1.5rem;
                font-weight: 600;
                color: #fff;
            }

            .wealth-title p {
                margin: 4px 0 0 0;
                font-size: 0.85rem;
                color: rgba(255, 255, 255, 0.6);
            }

            .wealth-amount {
                font-size: 1.8rem;
                font-weight: 700;
                color: #fff;
            }

            /* Chart container */
            .chart-container {
                flex: 1;
                position: relative;
                min-height: 350px;
            }

            .chart-title {
                font-size: 0.95rem;
                font-weight: 500;
                color: rgba(255, 255, 255, 0.8);
                margin-bottom: 15px;
            }

            /* Donut chart section */
            .donut-container {
                display: flex;
                align-items: center;
                justify-content: center;
                width: 100%;
                height: 300px;
                margin: 20px 0;
            }

            .donut-wrapper {
                width: 260px;
                height: 260px;
                position: relative;
            }

            /* Responsive */
            @media (max-width: 900px) {
                .wealth-grid {
                    grid-template-columns: 1fr;
                }
            }
        </style>

        <div class="wealth-page">
            <!-- Main Grid -->
            <div class="wealth-grid">

                <!-- LEFT: Main Chart Area -->
                <div class="wealth-main">
                    <div class="bento-box glow-hover" style="flex: 1; display: flex; flex-direction: column;">
                        <!-- Header -->
                        <div class="wealth-header">
                            <div class="wealth-title">
                                <h2>Total Wealth</h2>
                                <p>Overview of your complete financial portfolio</p>
                            </div>
                            <span class="wealth-amount">
                                <h:outputText value="#{totalWealthBean.totalNetWorth}">
                                    <f:convertNumber type="currency" currencySymbol="$" maxFractionDigits="2" />
                                </h:outputText>
                            </span>
                        </div>

                        <!-- Line Chart -->
                        <div class="chart-title">Total Net Worth Evolution</div>
                        <div class="chart-container">
                            <canvas id="netWorthChart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- RIGHT: Sidebar -->
                <div class="wealth-sidebar">
                    <!-- Wealth Breakdown Donut -->
                    <div class="bento-box glow-hover" style="flex: 1; display: flex; flex-direction: column;">
                        <h3 class="sidebar-title" style="text-align: center;">Wealth Breakdown</h3>
                        <div class="donut-container">
                            <div class="donut-wrapper">
                                <canvas id="wealthDonutChart"></canvas>
                            </div>
                        </div>
                    </div>

                    <!-- Quick Stats -->
                    <div class="bento-box glow-hover">
                        <h3 class="sidebar-title">Asset Summary</h3>
                        <div class="sidebar-list">
                            <div class="list-row">
                                <span class="row-main-text">Cash Balance</span>
                                <span class="row-amount" style="color: #13d6b1;">
                                    <h:outputText value="#{totalWealthBean.totalCash}">
                                        <f:convertNumber type="currency" currencySymbol="$" maxFractionDigits="2" />
                                    </h:outputText>
                                </span>
                            </div>
                            <div class="list-row">
                                <span class="row-main-text">Stocks</span>
                                <span class="row-amount" style="color: #0062ff;">
                                    <h:outputText value="#{totalWealthBean.totalStocks}">
                                        <f:convertNumber type="currency" currencySymbol="$" maxFractionDigits="2" />
                                    </h:outputText>
                                </span>
                            </div>
                            <div class="list-row">
                                <span class="row-main-text">Crypto</span>
                                <span class="row-amount" style="color: #ffce56;">
                                    <h:outputText value="#{totalWealthBean.totalCrypto}">
                                        <f:convertNumber type="currency" currencySymbol="$" maxFractionDigits="2" />
                                    </h:outputText>
                                </span>
                            </div>
                            <div class="list-row">
                                <span class="row-main-text">ETFs</span>
                                <span class="row-amount" style="color: #9b59b6;">
                                    <h:outputText value="#{totalWealthBean.totalEtf}">
                                        <f:convertNumber type="currency" currencySymbol="$" maxFractionDigits="2" />
                                    </h:outputText>
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Hidden Data Containers for JSON -->
        <div id="netWorthData" style="display:none;">
            <h:outputText value="#{totalWealthBean.netWorthHistoryJson}" escape="false" />
        </div>
        <div id="wealthDistData" style="display:none;">
            <h:outputText value="#{totalWealthBean.wealthDistributionJson}" escape="false" />
        </div>

        <script>
            document.addEventListener("DOMContentLoaded", function () {
                // Read JSON from hidden divs
                const nwRaw = document.getElementById('netWorthData').textContent;
                const distRaw = document.getElementById('wealthDistData').textContent;

                const netWorthHistory = JSON.parse(nwRaw);
                const wealthDistribution = JSON.parse(distRaw);

                // --- 1. Net Worth Line Chart ---
                const ctxLine = document.getElementById('netWorthChart').getContext('2d');

                // Gradient for fill
                let gradient = ctxLine.createLinearGradient(0, 0, 0, 350);
                gradient.addColorStop(0, 'rgba(255, 255, 255, 0.15)');
                gradient.addColorStop(1, 'rgba(255, 255, 255, 0.0)');

                new Chart(ctxLine, {
                    type: 'line',
                    data: {
                        labels: netWorthHistory.labels,
                        datasets: [{
                            label: 'Net Worth',
                            data: netWorthHistory.data,
                            borderColor: 'rgba(255, 255, 255, 0.8)',
                            backgroundColor: gradient,
                            borderWidth: 2,
                            pointRadius: 0,
                            pointHoverRadius: 5,
                            fill: true,
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                mode: 'index',
                                intersect: false,
                                backgroundColor: 'rgba(0,0,0,0.8)',
                                titleColor: '#fff',
                                bodyColor: '#fff',
                                borderColor: 'rgba(255,255,255,0.1)',
                                borderWidth: 1,
                                callbacks: {
                                    label: function (context) {
                                        return '$' + context.raw.toLocaleString('en-US', { minimumFractionDigits: 2 });
                                    }
                                }
                            }
                        },
                        scales: {
                            x: {
                                grid: { display: false, drawBorder: false },
                                ticks: { color: 'rgba(255,255,255,0.5)', maxTicksLimit: 10 }
                            },
                            y: {
                                grid: { color: 'rgba(255, 255, 255, 0.05)', drawBorder: false },
                                ticks: {
                                    color: 'rgba(255,255,255,0.5)',
                                    callback: function (value) {
                                        return '$' + value.toLocaleString();
                                    }
                                }
                            }
                        },
                        interaction: {
                            mode: 'nearest',
                            axis: 'x',
                            intersect: false
                        }
                    }
                });

                // --- 2. Wealth Breakdown Donut Chart ---
                const ctxDonut = document.getElementById('wealthDonutChart').getContext('2d');
                new Chart(ctxDonut, {
                    type: 'doughnut',
                    data: {
                        labels: ['Cash', 'Stocks', 'Crypto', 'ETFs'],
                        datasets: [{
                            data: wealthDistribution,
                            backgroundColor: [
                                '#13d6b1', // Teal (Cash)
                                '#0062ff', // Blue (Stocks)
                                '#ffce56', // Yellow (Crypto)
                                '#9b59b6'  // Purple (ETFs)
                            ],
                            borderWidth: 0,
                            hoverOffset: 4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        cutout: '70%',
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: {
                                    color: 'rgba(255,255,255,0.7)',
                                    usePointStyle: true,
                                    padding: 15,
                                    font: { size: 11 }
                                }
                            },
                            tooltip: {
                                backgroundColor: 'rgba(0,0,0,0.8)',
                                titleColor: '#fff',
                                bodyColor: '#fff',
                                callbacks: {
                                    label: function (context) {
                                        return context.label + ': $' + context.raw.toLocaleString('en-US', { minimumFractionDigits: 2 });
                                    }
                                }
                            }
                        }
                    }
                });
            });
        </script>

    </ui:define>
</ui:composition>