<ui:composition xmlns="http://www.w3.org/1999/xhtml" xmlns:h="http://xmlns.jcp.org/jsf/html"
    xmlns:f="http://xmlns.jcp.org/jsf/core" xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
    template="/templates/layout.xhtml">

    <ui:define name="title">Total Wealth - WealthMate</ui:define>

    <ui:define name="content">
        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

        <style>
            :root {
                --glass-bg: rgba(255, 255, 255, 0.05);
                --glass-border: rgba(255, 255, 255, 0.1);
                --text-primary: #ffffff;
                --text-secondary: #a0a0a0;
                --accent-color: #f7b924;
                /* Gold */
                --chart-color-1: #13d6b1;
                /* Teal */
                --chart-color-2: #0062ff;
                /* Blue */
                --chart-color-3: #ffce56;
                /* Yellow */
            }

            .wealth-dashboard {
                display: flex;
                flex-direction: column;
                gap: 20px;
                padding: 20px;
                color: var(--text-primary);
                font-family: 'Inter', sans-serif;
            }

            /* Header Section */
            .wealth-header {
                display: flex;
                flex-direction: column;
                margin-bottom: 10px;
            }

            .total-label {
                font-size: 1rem;
                color: var(--text-secondary);
                margin-bottom: 5px;
            }

            .total-amount {
                font-size: 2.5rem;
                font-weight: 700;
                background: linear-gradient(90deg, #fff, #ccc);
                -webkit-background-clip: text;
                -webkit-text-fill-color: transparent;
                background-clip: text;
            }

            /* Main Grid Layout */
            .charts-container {
                display: grid;
                grid-template-columns: 2fr 1fr;
                /* 2/3 and 1/3 ratio */
                gap: 20px;
                height: 500px;
            }

            /* Glassmorphism Cards */
            .glass-card {
                background: var(--glass-bg);
                border: 1px solid var(--glass-border);
                border-radius: 16px;
                padding: 24px;
                display: flex;
                flex-direction: column;
                backdrop-filter: blur(10px);
                box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            }

            .card-title {
                font-size: 1.1rem;
                font-weight: 600;
                margin-bottom: 20px;
                color: #e0e0e0;
            }

            .chart-wrapper {
                flex-grow: 1;
                position: relative;
                width: 100%;
                height: 100%;
            }

            /* Responsive */
            @media (max-width: 900px) {
                .charts-container {
                    grid-template-columns: 1fr;
                    /* Stack on mobile */
                    height: auto;
                }

                .glass-card {
                    height: 400px;
                }
            }
        </style>

        <div class="wealth-dashboard">
            <!-- Header -->
            <div class="wealth-header">
                <span class="total-label">Total Net Worth</span>
                <span class="total-amount">
                    <h:outputText value="#{totalWealthBean.totalNetWorth}">
                        <f:convertNumber type="currency" currencySymbol="$" maxFractionDigits="2" />
                    </h:outputText>
                </span>
            </div>

            <!-- Charts Grid -->
            <div class="charts-container">
                <!-- 1. Left: Line Chart (Net Worth) -->
                <div class="glass-card">
                    <div class="card-title">Total Net Worth Evolution</div>
                    <div class="chart-wrapper">
                        <canvas id="netWorthChart"></canvas>
                    </div>
                </div>

                <!-- 2. Right: Donut Chart (Wealth Breakdown) -->
                <div class="glass-card">
                    <div class="card-title">Total Wealth Breakdown</div>
                    <div class="chart-wrapper">
                        <canvas id="wealthDonutChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Hidden Data Containers for JSON -->
        <div id="netWorthData" style="display:none;">
            <h:outputText value="#{totalWealthBean.netWorthHistoryJson}" escape="false" />
        </div>
        <div id="wealthDistData" style="display:none;">
            <h:outputText value="#{totalWealthBean.wealthDistributionJson}" escape="false" />
        </div>

        <script>
            document.addEventListener("DOMContentLoaded", function () {
                // Read JSON from hidden divs (Safe approach)
                const nwRaw = document.getElementById('netWorthData').textContent;
                const distRaw = document.getElementById('wealthDistData').textContent;

                const netWorthHistory = JSON.parse(nwRaw);
                const wealthDistribution = JSON.parse(distRaw);
                // [Cash, Stocks, Crypto, ETFs]

                // --- 1. Net Worth Line Chart ---
                const ctxLine = document.getElementById('netWorthChart').getContext('2d');

                // Gradient for fill
                let gradient = ctxLine.createLinearGradient(0, 0, 0, 400);
                gradient.addColorStop(0, 'rgba(247, 185, 36, 0.2)'); // Gold alpha
                gradient.addColorStop(1, 'rgba(247, 185, 36, 0.0)');

                new Chart(ctxLine, {
                    type: 'line',
                    data: {
                        labels: netWorthHistory.labels,
                        datasets: [{
                            label: 'Net Worth',
                            data: netWorthHistory.data,
                            borderColor: '#f7b924', // Gold
                            backgroundColor: gradient,
                            borderWidth: 2,
                            pointRadius: 0, // Smooth line without dots usually cleaner
                            pointHoverRadius: 5,
                            fill: true,
                            tension: 0.4 // Smooth curve
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                mode: 'index',
                                intersect: false,
                                backgroundColor: 'rgba(0,0,0,0.8)',
                                titleColor: '#fff',
                                bodyColor: '#fff',
                                borderColor: 'rgba(255,255,255,0.1)',
                                borderWidth: 1
                            }
                        },
                        scales: {
                            x: {
                                grid: { display: false, drawBorder: false },
                                ticks: { color: '#666', maxTicksLimit: 10 }
                            },
                            y: {
                                grid: { color: 'rgba(255, 255, 255, 0.05)', drawBorder: false },
                                ticks: { color: '#666' }
                            }
                        },
                        interaction: {
                            mode: 'nearest',
                            axis: 'x',
                            intersect: false
                        }
                    }
                });

                // --- 2. Wealth Breakdown Donut Chart ---
                const ctxDonut = document.getElementById('wealthDonutChart').getContext('2d');
                new Chart(ctxDonut, {
                    type: 'doughnut',
                    data: {
                        labels: ['Cash', 'Stocks', 'Crypto', 'ETFs'],
                        datasets: [{
                            data: wealthDistribution,
                            backgroundColor: [
                                '#13d6b1', // Teal (Cash)
                                '#0062ff', // Blue (Stocks)
                                '#ffce56', // Yellow (Crypto)
                                '#9b59b6'  // Purple (ETFs)
                            ],
                            borderWidth: 0,
                            hoverOffset: 4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        cutout: '70%', // Thinner ring
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: {
                                    color: '#a0a0a0',
                                    usePointStyle: true,
                                    padding: 20,
                                    font: { size: 12 }
                                }
                            }
                        }
                    }
                });
            });
        </script>

    </ui:define>
</ui:composition>