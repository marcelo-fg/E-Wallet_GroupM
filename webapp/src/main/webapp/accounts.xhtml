<ui:composition xmlns="http://www.w3.org/1999/xhtml"
                xmlns:h="jakarta.faces.html"
                xmlns:ui="jakarta.faces.facelets"
                xmlns:f="jakarta.faces.core"
                template="/templates/layout.xhtml">

    <!-- Titre de l'onglet navigateur -->
    <ui:define name="title">Comptes bancaires</ui:define>

    <!-- Style spécifique de fond pour la page comptes (optionnel, comme dashboard) -->
    <ui:define name="pageStyle">
        <style>
            body.dashboard-page {
                background: url("#{request.contextPath}/resources/images/bg-dashboard_1.png") center/cover no-repeat fixed !important;
            }
        </style>
    </ui:define>

    <ui:define name="content">
        <!-- Ajout de accounts-page pour scoper le CSS -->
        <div class="page-content accounts-page">

            <!-- Grille principale 2 colonnes -->
            <div class="bento-dashboard">

                <!-- COLONNE GAUCHE : résumé + liste + nouvelle transaction -->
                <div class="bento-main">

                    <!-- Carte : Mes Comptes Bancaires / Total solde -->
                    <h:panelGroup layout="block" styleClass="bento-box glow-hover">

                        <h2>Mes Comptes Bancaires</h2>
                        <p class="bento-description">
                            Total Solde Disponible :
                        </p>

                        <!-- Total calculé à partir de la liste des comptes -->
                        <h3 style="font-size:32px; margin:10px 0 20px 0;">
                            <h:outputText value="#{accountBean.totalBalance}">
                                <f:convertNumber maxFractionDigits="2" type="number" />
                            </h:outputText>
                            <span>CHF</span>
                        </h3>

                        <!-- Bouton création d’un nouveau compte -->
                        <h:form id="createAccountForm">
                            <h:commandButton value="Créer un nouveau compte"
                                             styleClass="btn-primary"
                                             action="#{accountBean.startCreation}">
                                <f:ajax render="accountTypePanel accountsTable detailsPanel" execute="@form" />
                            </h:commandButton>
                        </h:form>
                    </h:panelGroup>

                    <!-- Carte : Liste de mes comptes -->
                    <h:panelGroup layout="block" styleClass="bento-box glow-hover" id="accountsTable">

                        <h3>Liste de mes Comptes</h3>
                        <p class="bento-description">
                            Overview de tous vos comptes bancaires.
                        </p>

                        <!-- Sélecteur type + nom de compte (création) -->
                        <h:panelGroup id="accountTypePanel"
                                      rendered="#{accountBean.showTypeSelector}">
                            <h:form id="typeSelectorForm">
                                <div style="margin-top:16px; display:flex; gap:12px; align-items:flex-end; flex-wrap:wrap;">

                                    <!-- Type de compte -->
                                    <div class="form-field" style="flex:1; min-width:220px;">
                                        <h:outputLabel value="Type de compte" styleClass="field-label" />
                                        <h:selectOneMenu value="#{accountBean.selectedType}"
                                                         styleClass="select-field">
                                            <f:selectItem itemValue="Courant" itemLabel="Compte courant" />
                                            <f:selectItem itemValue="Épargne" itemLabel="Compte épargne" />
                                        </h:selectOneMenu>
                                    </div>

                                    <!-- Nom du compte -->
                                    <div class="form-field" style="flex:1; min-width:220px;">
                                        <h:outputLabel value="Nom du compte" styleClass="field-label" />
                                        <h:inputText value="#{accountBean.newAccountName}"
                                                     styleClass="input-field"
                                                     maxlength="40" />
                                    </div>

                                    <!-- Actions création / annulation -->
                                    <div style="display:flex; gap:8px;">
                                        <h:commandButton value="Créer"
                                                         styleClass="btn-primary"
                                                         action="#{accountBean.createAccount}">
                                            <f:ajax execute="@form"
                                                    render="accountsTable detailsPanel accountTypePanel" />
                                        </h:commandButton>

                                        <h:commandButton value="Annuler"
                                                         styleClass="btn-ghost"
                                                         action="#{accountBean.cancelCreation}">
                                            <f:ajax execute="@form"
                                                    render="accountTypePanel" />
                                        </h:commandButton>
                                    </div>
                                </div>
                            </h:form>
                        </h:panelGroup>

                        <!-- Table des comptes -->
                        <h:form id="accountsListForm" style="margin-top:18px; display:block;">
                            <table style="width:100%; border-collapse:separate; border-spacing:0 6px; font-size:14px;">
                                <thead>
                                <tr style="opacity:0.8; text-align:left;">
                                    <th style="padding:6px 10px;">Type de Compte</th>
                                    <th style="padding:6px 10px;">Nom du Compte</th>
                                    <th style="padding:6px 10px;">Solde Actuel</th>
                                    <th style="padding:6px 10px; text-align:right;">Action</th>
                                </tr>
                                </thead>
                                <tbody>
                                <ui:repeat value="#{accountBean.accounts}" var="c">
                                    <tr class="assets-row">
                                        <td>#{c.type}</td>
                                        <td>#{empty c.name ? c.number : c.name}</td>
                                        <td>
                                            <h:outputText value="#{c.balance}">
                                                <f:convertNumber maxFractionDigits="2" type="number" />
                                            </h:outputText>
                                            <span>CHF</span>
                                        </td>
                                        <td style="text-align:right;">
                                            <!-- Sélectionne le compte -->
                                            <h:commandButton value="Détails"
                                                             styleClass="btn-secondary"
                                                             action="#{accountBean.selectAccount(c.id)}">
                                                <f:ajax execute="@this" render="detailsPanel" />
                                            </h:commandButton>
                                        </td>
                                    </tr>
                                </ui:repeat>
                                </tbody>
                            </table>
                        </h:form>

                    </h:panelGroup>

                    <!-- Nouvelle activité : sous la liste des comptes -->
                    <h:panelGroup layout="block" styleClass="bento-box glow-hover"
                                  rendered="#{not empty accountBean.accounts}">
                        <h3>Ajouter une Activité</h3>
                        <p class="bento-description">
                            Choisissez un compte puis ajoutez, retirez ou transférez de l'argent.
                        </p>

                        <h:form id="transactionForm" style="margin-top:14px;">

                            <!-- Type d'opération : dépôt / retrait / transfert -->
                            <div class="form-field">
                                <h:outputLabel value="Type d'opération" styleClass="field-label" />
                                <h:selectOneMenu value="#{accountBean.operationType}"
                                                 styleClass="select-field">
                                    <f:selectItem itemValue="DEPOSIT" itemLabel="Dépôt" />
                                    <f:selectItem itemValue="WITHDRAWAL" itemLabel="Retrait" />
                                    <f:selectItem itemValue="TRANSFER" itemLabel="Transfert" />
                                    <f:ajax render="accountField transferFields categoryField" />
                                </h:selectOneMenu>
                            </div>

                            <!-- Compte cible pour dépôt / retrait -->
                            <h:panelGroup id="accountField"
                                          rendered="#{accountBean.operationType ne 'TRANSFER'}">
                                <div class="form-field">
                                    <h:outputLabel value="Compte" styleClass="field-label" />
                                    <h:selectOneMenu value="#{accountBean.selectedAccountId}"
                                                     styleClass="select-field">
                                        <f:selectItems value="#{accountBean.accounts}"
                                                       var="acc"
                                                       itemValue="#{acc.id}"
                                                       itemLabel="#{empty acc.name ? acc.type.concat(' - ').concat(acc.number) : acc.name}" />
                                        <f:ajax listener="#{accountBean.selectAccount(accountBean.selectedAccountId)}"
                                                render="detailsPanel" />
                                    </h:selectOneMenu>
                                </div>
                            </h:panelGroup>

                            <!-- Champs spécifiques au transfert -->
                            <h:panelGroup id="transferFields"
                                          rendered="#{accountBean.operationType eq 'TRANSFER'}">
                                <div class="form-field">
                                    <h:outputLabel value="Compte source" styleClass="field-label" />
                                    <h:selectOneMenu value="#{accountBean.transferSourceAccountId}"
                                                     styleClass="select-field">
                                        <f:selectItems value="#{accountBean.accounts}"
                                                       var="acc"
                                                       itemValue="#{acc.id}"
                                                       itemLabel="#{empty acc.name ? acc.type.concat(' - ').concat(acc.number) : acc.name}" />
                                    </h:selectOneMenu>
                                </div>

                                <div class="form-field">
                                    <h:outputLabel value="Compte destinataire" styleClass="field-label" />
                                    <h:selectOneMenu value="#{accountBean.transferTargetAccountId}"
                                                     styleClass="select-field">
                                        <f:selectItems value="#{accountBean.accounts}"
                                                       var="acc"
                                                       itemValue="#{acc.id}"
                                                       itemLabel="#{empty acc.name ? acc.type.concat(' - ').concat(acc.number) : acc.name}" />
                                    </h:selectOneMenu>
                                </div>
                            </h:panelGroup>

                            <!-- Catégorie dynamique selon type -->
                            <h:panelGroup id="categoryField">
                                <div class="form-field">
                                    <h:outputLabel value="Catégorie" styleClass="field-label" />
                                    <h:selectOneMenu value="#{accountBean.expenseCategory}"
                                                     styleClass="select-field">
                                        <f:selectItem itemValue="" itemLabel="-- Aucune / Inconnue --" />
                                        <f:selectItems value="#{accountBean.expenseCategories}" />
                                    </h:selectOneMenu>
                                </div>
                            </h:panelGroup>

                            <!-- Montant -->
                            <div class="form-field">
                                <h:outputLabel value="Montant" styleClass="field-label" />
                                <h:inputText value="#{accountBean.amount}"
                                             styleClass="input-field">
                                    <f:convertNumber maxFractionDigits="2" type="number" />
                                </h:inputText>
                            </div>

                            <!-- Commentaire -->
                            <div class="form-field">
                                <h:outputLabel value="Commentaire" styleClass="field-label" />
                                <h:inputTextarea value="#{accountBean.transactionDescription}"
                                                 styleClass="input-field"
                                                 rows="2" />
                            </div>

                            <div style="margin-top:16px;">
                                <h:commandButton value="Confirmer l’Activité"
                                                 styleClass="btn-primary full-width"
                                                 action="#{accountBean.confirmOperation}">
                                    <f:ajax execute="@form"
                                            render="detailsPanel accountsTable" />
                                </h:commandButton>
                            </div>

                        </h:form>
                    </h:panelGroup>

                </div>

                <!-- COLONNE DROITE : historique simplifié + détails -->
                <div class="bento-sidebar" id="detailsPanel">

                    <h:panelGroup layout="block" styleClass="bento-box glow-hover">
                        <h3>Historique des Transactions</h3>
                        <p class="bento-description">
                            Dernières opérations pour le compte sélectionné.
                        </p>

                        <!-- Historique vide -->
                        <h:panelGroup rendered="#{empty accountBean.selectedAccountTransactions}">
                            <p style="margin-top:12px; font-size:13px; opacity:0.8;">
                                Aucune transaction pour l'instant.
                            </p>
                        </h:panelGroup>

                        <!-- Historique compact -->
                        <h:panelGroup rendered="#{not empty accountBean.selectedAccountTransactions}">
                            <table style="width:100%; border-collapse:separate; border-spacing:0 4px; font-size:13px; margin-top:12px;">
                                <thead>
                                <tr style="opacity:0.8; text-align:left;">
                                    <th style="width:10%;">#</th>
                                    <th style="width:25%;">Date</th>
                                    <th style="width:35%;">Compte</th>
                                    <th style="width:20%; text-align:right;">Montant</th>
                                    <th style="width:10%; text-align:right;">Action</th>
                                </tr>
                                </thead>
                                <tbody>
                                <ui:repeat value="#{accountBean.selectedAccountTransactions}" var="tx" varStatus="st">
                                    <tr>
                                        <td>#{st.index + 1}</td>
                                        <td>
                                            <!-- LocalDateTime affiché brut (évite le convertisseur JSF) -->
                                            <h:outputText value="#{tx.dateTime}" />
                                        </td>
                                        <td>
                                            <h:outputText value="#{accountBean.findAccountById(tx.accountId).name}" />
                                        </td>
                                        <td style="text-align:right;">
                                            <h:outputText value="#{tx.amount}">
                                                <f:convertNumber maxFractionDigits="2" type="number" />
                                            </h:outputText>
                                            <span>CHF</span>
                                        </td>
                                        <td style="text-align:right;">
                                            <h:commandButton value="Détails"
                                                             styleClass="btn-secondary"
                                                             actionListener="#{accountBean.setSelectedTransaction(tx)}">
                                                <f:ajax render="transactionDetailsPanel" />
                                            </h:commandButton>
                                        </td>
                                    </tr>
                                </ui:repeat>
                                </tbody>
                            </table>
                        </h:panelGroup>

                        <!-- Panneau de détails d'une transaction -->
                        <h:panelGroup id="transactionDetailsPanel"
                                      layout="block"
                                      rendered="#{not empty accountBean.selectedTransaction}">
                            <hr style="margin:16px 0; border:none; border-top:1px solid rgba(255,255,255,0.08);" />
                            <h4 style="margin:0 0 8px 0;">Détails de la transaction</h4>

                            <p style="font-size:13px; margin:2px 0;">
                                <strong>Date et heure :</strong>
                                <h:outputText value="#{accountBean.selectedTransaction.dateTime}" />
                            </p>
                            <p style="font-size:13px; margin:2px 0;">
                                <strong>Type :</strong>
                                #{accountBean.selectedTransaction.type}
                            </p>
                            <p style="font-size:13px; margin:2px 0;">
                                <strong>Catégorie :</strong>
                                #{accountBean.selectedTransaction.category}
                            </p>
                            <p style="font-size:13px; margin:2px 0;">
                                <strong>Commentaire :</strong>
                                #{accountBean.selectedTransaction.description}
                            </p>
                        </h:panelGroup>
                    </h:panelGroup>
                </div>

            </div>
        </div>
    </ui:define>
</ui:composition>
