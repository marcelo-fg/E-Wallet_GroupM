<ui:composition xmlns="http://www.w3.org/1999/xhtml" xmlns:h="jakarta.faces.html" xmlns:ui="jakarta.faces.facelets"
    xmlns:f="jakarta.faces.core" template="/templates/layout.xhtml">

    <ui:define name="title">Portfolio Analytics</ui:define>

    <!-- Use dashboard background -->
    <ui:define name="pageStyle">
        <style>
            body.dashboard-page {
                background: url("#{request.contextPath}/resources/images/bg-dashboard_1.png") center/cover no-repeat fixed !important;
            }
        </style>
    </ui:define>

    <f:metadata>
        <f:event type="preRenderView" listener="#{portfolioBean.ensureAnalyticsData}" />
    </f:metadata>

    <ui:define name="content">
        <div class="portfolio-page">

            <!-- Header with Back Button -->
            <div style="margin-bottom: 15px; display:flex; align-items:center; justify-content: space-between;">
                <div style="display:flex; align-items:center; gap:16px;">
                    <div onclick="window.location.href='portfolio.xhtml';"
                        style="cursor:pointer; background:rgba(255,255,255,0.1); padding:8px 16px; border-radius:12px; display:flex; align-items:center; gap:8px;">
                        <span>&#8592; Back</span>
                    </div>
                    <h2 style="margin:0; font-size:24px;">Analytics:
                        #{portfolioBean.portfolioNames[portfolioBean.selectedPortfolioId]}</h2>
                </div>
            </div>

            <h:panelGroup rendered="#{empty portfolioBean.selectedPortfolioId}">
                <div class="bento-box glow-hover">
                    <h3>No Portfolio Selected</h3>
                    <p>Please select a portfolio from the main page.</p>
                </div>
            </h:panelGroup>

            <h:panelGroup rendered="#{not empty portfolioBean.selectedPortfolioId}" layout="block"
                class="portfolio-dashboard">

                <!-- Chart Card Styles -->
                <style>
                    .analytics-grid {
                        display: grid;
                        grid-template-columns: 3fr 1fr;
                        gap: 15px;
                    }

                    .chart-card {
                        width: 100%;
                        height: 450px;
                        background: rgba(20, 20, 30, 0.8);
                        backdrop-filter: blur(10px);
                        border: 1px solid rgba(255, 255, 255, 0.1);
                        border-radius: 16px;
                        padding: 20px;
                        display: flex;
                        flex-direction: column;
                        transition: all 0.3s ease;
                    }

                    .chart-card:hover {
                        border-color: rgba(255, 255, 255, 0.3);
                        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
                    }
                </style>

                <div class="analytics-grid">

                    <!-- LEFT COL: PORTFOLIO VALUE CHART -->
                    <div class="chart-card">
                        <div class="card-header" style="margin-bottom: 15px;">
                            <h3>Portfolio Value Evolution</h3>
                            <p style="margin: 5px 0 0 0; opacity:0.6; font-size:12px;">7 Day History</p>
                        </div>
                        <div style="flex:1; position:relative;">
                            <canvas id="portfolioChart"></canvas>
                        </div>
                    </div>


                    <!-- RIGHT COL: METRICS SIDEBAR (Standard Position) -->
                    <div class="bento-sidebar" style="display:flex; flex-direction:column; gap:15px;">
                        <!-- Total Value -->
                        <div class="bento-box glow-hover"
                            style="flex:1; display:flex; flex-direction:column; justify-content:center; align-items:center;">
                            <h3 style="font-size:16px; opacity:0.8; margin-bottom:8px;">Total Valuation</h3>
                            <h:outputText value="#{portfolioBean.formattedTotalPortfolioValue}"
                                styleClass="animate-count" style="font-size:32px; font-weight:700; color: #ffffff;" />
                        </div>

                        <!-- Realized PnL -->
                        <div class="bento-box glow-hover"
                            style="flex:1; display:flex; flex-direction:column; justify-content:center; align-items:center;">
                            <h3 style="font-size:16px; opacity:0.8; margin-bottom:8px;">Realized PnL</h3>
                            <h:outputText value="#{portfolioBean.realizedPnl}" styleClass="animate-count"
                                style="font-size:28px; font-weight:600; color: #{portfolioBean.realizedPnl >= 0 ? '#30d158' : '#ff453a'};">
                                <f:convertNumber type="currency" currencyCode="USD" />
                            </h:outputText>
                            <p class="bento-description">Profit/Loss from sold assets</p>
                        </div>
                    </div>
                </div>

                <!-- JAVASCRIPT FOR CHARTS -->
                <h:panelGroup id="chartScriptPanel">

                    <!-- Hidden inputs to pass JSON safely -->
                    <h:inputHidden id="pfChartJson" value="#{portfolioBean.portfolioChartJson}" />

                    <script type="text/javascript">
                        //<![CDATA[
                        document.addEventListener('DOMContentLoaded', function () {
                            initCharts();
                        });

                        // Also call on AJAX updates
                        if (document.readyState === 'complete') {
                            initCharts();
                        }

                        function initCharts() {
                            console.log('Initializing portfolio chart...');

                            // Helper to read JSON from hidden field by partial ID
                            function getJsonData(partialId) {
                                // Use simple quotes for CSS selector
                                var input = document.querySelector("input[id$='" + partialId + "']");
                                if (input && input.value && input.value !== 'null') {
                                    try {
                                        return JSON.parse(input.value);
                                    } catch (e) {
                                        console.error('Error parsing JSON for ' + partialId, e);
                                        return null;
                                    }
                                }
                                return null;
                            }

                            // PORTFOLIO CHART
                            var ctx1 = document.getElementById('portfolioChart');
                            if (ctx1) {
                                if (window.pfChart) { window.pfChart.destroy(); }
                                var data1 = getJsonData('pfChartJson');
                                if (data1) {
                                    window.pfChart = new Chart(ctx1.getContext('2d'), {
                                        type: 'line',
                                        data: data1,
                                        options: {
                                            responsive: true,
                                            maintainAspectRatio: false,
                                            interaction: { mode: 'index', intersect: false },
                                            plugins: { legend: { labels: { color: 'white' } } },
                                            scales: {
                                                x: { grid: { color: 'rgba(255,255,255,0.1)' }, ticks: { color: 'rgba(255,255,255,0.7)' } },
                                                y: { grid: { color: 'rgba(255,255,255,0.1)' }, ticks: { color: 'rgba(255,255,255,0.7)' } }
                                            }
                                        }
                                    });
                                }
                            }
                        }
                        //]]>
                    </script>
                </h:panelGroup>

                <!-- ASSETS BREAKDOWN TABLE (Bottom, Full Width) -->
                <div class="bento-box glow-hover" style="margin-top:15px;">
                    <h3 style="margin-bottom:15px;">Holdings Performance</h3>
                    <table style="width:100%; border-collapse:separate; border-spacing:0 8px; font-size:14px;">
                        <thead>
                            <tr style="text-align:left; opacity:0.7;">
                                <th>Asset</th>
                                <th style="text-align:right;">Qty</th>
                                <th style="text-align:right;">Avg Buy Price</th>
                                <th style="text-align:right;">Current Price</th>
                                <th style="text-align:right;">Market Value</th>
                                <th style="text-align:right;">Unrealized PnL</th>
                            </tr>
                        </thead>
                        <tbody>
                            <ui:repeat value="#{portfolioBean.analyticsAssets}" var="asset">
                                <tr style="background:rgba(255,255,255,0.05); border-radius:8px;">
                                    <td style="padding:12px; border-radius:8px 0 0 8px;">
                                        <strong>#{asset.symbol}</strong> <span
                                            style="opacity:0.6; font-size:12px;">(#{asset.type})</span>
                                    </td>
                                    <td style="text-align:right; padding:12px;">
                                        <h:outputText value="#{asset.quantity}">
                                            <f:convertNumber pattern="#,##0.00######" />
                                        </h:outputText>
                                    </td>
                                    <td style="text-align:right; padding:12px;">
                                        <h:outputText value="#{asset.averageBuyPrice}">
                                            <f:convertNumber type="currency" currencyCode="USD" />
                                        </h:outputText>
                                    </td>
                                    <td style="text-align:right; padding:12px;">
                                        <h:outputText value="#{asset.unitPrice}">
                                            <f:convertNumber type="currency" currencyCode="USD" />
                                        </h:outputText>
                                    </td>
                                    <td style="text-align:right; padding:12px;">
                                        <h:outputText value="#{asset.totalValue}">
                                            <f:convertNumber type="currency" currencyCode="USD" />
                                        </h:outputText>
                                    </td>
                                    <td style="text-align:right; padding:12px; border-radius:0 8px 8px 0;">
                                        <h:outputText value="#{asset.pnl}"
                                            style="font-weight:600; color: #{asset.pnl >= 0 ? '#30d158' : '#ff453a'};">
                                            <f:convertNumber type="currency" currencyCode="USD" />
                                        </h:outputText>
                                    </td>
                                </tr>
                            </ui:repeat>
                        </tbody>
                    </table>
                </div>

            </h:panelGroup>

        </div>
    </ui:define>
</ui:composition>